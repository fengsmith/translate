https://en.wikipedia.org/wiki/Concurrency_control#Database_transaction_and_the_ACID_rules
#并发控制
在信息技术和计算机科学中，尤其是计算机编程，操作系统，多处理器和数据库领域，并发控制的目的就是确保并发操作产生正确的结果，同时执行得越快越好。


计算机系统，包括软件系统和硬件系统，都是由模块或者是组件组成。每个组件都被设计的可以正常工作，即遵守或满足确定的一致性规则。当组件之间通过发送消息或者是共享的数据（在内存中或其他存储中）来交互，实现并发操作，某一个组件的一致性可能会被另外一个组件给违反了。并发控制的通用领域提供了规则、方法、设计方法在组件并发执行并交互时维护各个组件的一致性，从而达到了整个系统的一致性和正确性。在系统中引入并发控制意味着应用操作约束，然而应用操作约束将会降低性能。在获得操作一致性和正确性的前提下程序执的性能应该不能低于合理的水平，当然越高效越好。与简单的顺序执行算法相比，在并发算法中，并发控制会额外引入不小的复杂性和开销。


例如，从撕裂的读或写操作中可以看出并发控制失败将会导致数据污染。

## 并发控制在数据库中的应用
在数据库管理系统、其他事务性对象和相关分布式应用中，可以通过并发控制来确保数据库事物被正确的并发执行而不会违反相应数据库的数据完整性约束。  在任何系统中只要有两个或两个以上的事物同时交错执行，并且这些事物可以同时访问同一个数据块，为了保证系统的正确性，并发控制是系统必须的一部分。事实上，任何通用数据库系统都有并发控制能力。因此，从 20 世纪 70 年代初，数据库系统出现以后到现在已经积累了大量的有关数据库系统的并发研究。可串行性理论是一个完善的数据库并发控制理论，它是数据库并发相关研究的总纲，通过该理论可以高效的设计和分析并发控制方法和机制。另一种原子事物的并发控制理论是 Lynch et 在 1993 年提出的基于抽象数据类型的并发控制理论，该理论并没有被广泛应用。该理论更精炼和复杂，适用范围也更广，与上面提到的古典的数据库并发理论相比其应用性要低。每种理论都有其优缺点，侧重性性和预见性。某种程度上它们是互补的，两者结合起来应用可能会更好。

 为了确保正确性，数据库管理系统保证只可串行化化事物调度被生成，除非可串行化事物故意放松来提高性能，只有在应用的正确性不被破坏的前提下。为了在事物终止（事物终止发生的原因有很多种）的情况下也能维护正确性，调度应该有从终止恢复的属性。数据库管理系统也保证任何已提交的事物的影响都不会丢失。终止（回滚）的事物的不会对相关数据库造成影响。整体上来说事物的特征经常被总结为 ACID 规则。随着分布式数据库的出现或者需要在分布式环境操作，高效的分布式并发控制机制得到了特殊的注意。

## 数据库事物和 ACID 规则
为了使具有良好理解的数据库系统在易于出错的环境中不管奔溃多少次，而且还可以从奔溃中恢复到良好的可理解的数据库状态，数据库事物的概念已经发展了。数据库事物是一个工作单元，封装了数据库上的若干个典型的操作（比如，读取数据库中的对象，写，获取锁等），支持数据库和其他系统的抽象。每个事物都有明确定义的边界，包括哪些程序/代码执行事物（取决于编写事物的程序员通过特殊的事物命令）。每个数据库事物遵守以下的规则（由数据库系统支持；数据库系统的目的就是保证其运行的事物遵守这些规则）：

- 原子性 - 当一个事物完成后（提交或终止），要么所有的影响都保留要么没有任何影响保留（“所有或什么也没有”语义）。换句话说，一个提交的事物让外界来看（通过事物对数据库的影响）是不可分的（原子性），一个终止的事物一点也不会影响到数据库，就像这个事物没有执行过一样。 
- 一致性 - 每一个事物必须使数据库处于一致的（正确的）状态，例如，维护预定的数据库的完整性约束规则（数据库对象以及数据库对象之间的约束）。一个事物必须使数据库从一种一致的状态转换到另一种一致的状态（然而，确保事物本身的正确，这是编写事物的程序员的职责，例如，正确地按照应用程序员的想法来执行（从应用程序的角度来讲），而一致性则是由数据库管理系统来强制维护预定义好的完整性约束）。通常数据库只能通过事物来改变，因此所有的数据库状态都是一致的。
- 隔离性 - 事物之间不能相互干扰（事物的执行作为最终的结果）。此外，通常（依赖并发控制的方法）未完成事物的影响对其他事物甚至是不可见的。提供隔离是并发控制的主要目标。
- 持久性 - 成功的事物（已提交的事物）产生的影响必须禁受得住系统奔溃的考验（通常通过把事物产生的影响和提交事件记录到持久化存储中实现的）。

经过这些年的发展，原子性事物的概念已经被扩展到业务事物。业务事物实现了几种工作流，事实上业务事物并不是原子的。然而，这种强化的业务事物通常也使用原子事物作为其中的一个组件。

## 并发控制的必要性
如果所有的事物都顺序执行即在时间线上是不会产生交错的，也就不会有并发的事物存在。然而，如果允许并发事物交错执行而不施加任何控制措施，就会产生一些意外的、错误的结果，例如：
1、更新丢失问题：多个事物并发执行，第一个事物更新了一块数据，然后第二个事物又更新了这块数据，第二个事物把第一个事物更新的结果给覆盖了，第一个事物更新的数据就丢失了。而其他并发执行的事物可能先需要读取的数据是第一个事物更新的结果。实际上这些事物读取到的数据却是第二个事物更新后的结果，事物读取到的是错误的数据导致了错误的结果。

2、读脏数据问题：多个事物并发执行，其中一个事物由于某种原因终止了，但其他事物读取到了这个终止的事物写入的数据，脏读就是这样产生的。终止的事物改变的数据最终都会通过数据库的回滚操作而还原，而这些最终被还原的数据是不应该被其他事物读取到的。因此，那些读取到脏数据的事物最终会产生错误的结果。

3、不正确的统计问题：一个事物正在对同一张数据库表的若干条记录（行）的某一字段（列）做统计，同时第二个事物更新了这些记录中的某些记录的字段（列）。不管这两个事物哪个优先执行，这个统计结果都不能反映出正确的结果（通常需要保证正确性），然而也并不是随机的结果，与更新的时间和更新的记录是否在统计的记录中有关系。

大部分的高性能事物系统都需要并发执行事物来满足其性能要求。因此，如果没有并发控制，这些系统既不能提供正确性也不能维护数据库的一致性。
## 并发控制的机制

### 分类
并发控制机制的主要分类：

- 乐观 - 延迟检查一个事物是否满足隔离性和其他完整性约束条件（例如，可序列化性和可恢复性），不阻塞事物的任意、（读、写）操作（“对事物满足各种规则持有乐观态度”），直到事物要提交时，如果事物违反了规则，则终止事物，阻止了事物的各种规则的违反。终止了的事物立即重新开始执行，这会带来明显的开销（与只执行一次事物相比）。如果没有过多的事物被终止，乐观性通常是个不错的策略。
- 悲观 - 如果一个事物可能会违反规则，则阻塞其他事物的所有操作，知道这种可能性消失。阻塞操作通常会降低性能。
- 半乐观 -  

## 方法
有许多并发控制的方法。大部分并发控制的方法都可以用上述的并发控制的机制来实现。每一种主要的并发控制的方法都有好多种变体，有些方法会有重叠或结合。下面是一些方法：
1、锁（例如，两个阶段锁）- 通过分配给数据的锁来访问数据。一个事物需要访问数据库的一块数据，而这块数据已经被另外一个事物锁定，这个事物可能会被阻塞（与锁的种类和访问的操作类型（读、写）有关），直到另外一个事物把锁释放。
2、串行化图检查（也称为可串行性或冲突或优先顺序图检查）- 在调度图谱中检查到循环然后终止所有的事物。
3、时间戳顺序（TO）- 给每个事物分配一个时间戳，通过时间戳的顺序来控制访问数据的顺序。
4、提交顺序 （CO）- 控制或检查事物的提交事件的时间顺序来作为相应事物的优先级顺序。
 还用到几种并发类型，这几种并发类型与上面提到的那几种方法相关，包括：
- 多版本并发控制（MCCC）- 为了增加并发和性能，每次写操作时都为数据库对象产生一个新的版本，允许事物读取最新的几个版本（每个对象的）依赖具体的调度方法。
- 索引并发控制-对数据的索引进行同步访问，而不是数据本身。提供特殊的方法会带来显著的性能收益。
- 私有工作空间模型（默认更新）-每个事物为其访问的数据维护了一个私有的工作空间，只有该事物被提交以后其改变的数据才会对其他事物可见。在许多情况下，该模型提供了不同的并发控制行为与收益。
 从 1970 年早期数据库系统理论提出到现在，最常见的并发控制机制类型是：强严格两个阶段锁（SS2PL；也叫严格调度或者是严格 2PL），强严格两个阶段锁是两个阶段锁和提交顺序（CO）的特例（变体）。强严格两个阶段锁是悲观的。尽管强严格两个阶段锁的名字很长（由于历史原因），然而其机制是简单的：“只有在事物结束后才释放加在其上的所有锁。”强严格两个阶段锁（或者严谨性）也是所有的调度的名称，调度可以用这种机制来产生，例如，这些 SS2PL（或者严格性）调度拥有 SS2PL（或严格性）属性。 
## 并发控制机制的主要目标
并发控制的机制首先需要正确地操作，例如，在事物并发执行时，维护每个事物的完整性规则（并发相关，应用规范的完整性约束不在本文讨论的范围内），因此维护了整个事物式系统的完整性。在保证正确性的前提下，尽量获取最大的性能。除此之外，随着基于多处理器，多计算机和计算机网络的分布式事物的增多，更需要高效的操作。恢复和复制是影响并发控制的其他主题。
正确性
可串行性
为了保证正确性，对于大多数并发控制机制来说，常见的主要目标是使用可串行性属性来产生调度。如果没有可串行性可能会发生意想不到的不良后果，例如，钱可能会从账户中凭空消失，或者是凭空多出来些钱。可串行性调度等同（从数据库的角度来看）于对同样的事物进行顺序调度（例如，在顺序调度中事物之间在时间线上不会有重叠，因此，事物之间是彻底地隔离地：任意两个事物都不可能并行访问同一块数据）。在数据库事物中，可串行性是最高的隔离级别，也是并发事物的主要正确性标准。
有些情形下还需要妥协，例如，为了获得更好的性能或者是在分布式系统（看最终一致性）中满足高可用性的需求，需要放松可串行性的形式，但保证应用程序的正确性是前提（例如，由于放松以后钱可能凭空消失也可能凭空多出来，所以在货币交易中是不允许放松的）。
##可恢复性
注释：在一般系统的领域内"可恢复性"这个术语指一个系统从失败或者是不正确/禁止的状态恢复到正常状态的能力。而在数据库系统并发控制领域内，"可恢复性"有特殊的含义。
并发控制可以使事物终止（事物终止的原因可能有多重）时仍然能保持程序的正确性，并发控制可以典型的确保调度的可恢复性。恢复（从终止中）是指在一次调度中未提交的事物读取到了被终止的事物改写的数据。








  
